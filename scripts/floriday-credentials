#!/usr/bin/env bash
# Script to manage Floriday credentials using 1Password.
#
# Usage:
#   Load credentials:
#     eval $(./scripts/floriday-credentials load "Serra Vine")
#
#   Unset credentials:
#     eval $(./scripts/floriday-credentials unset)

set -e

VARIABLES=(
    "FLORIDAY_CLIENT_ID"
    "FLORIDAY_CLIENT_SECRET"
    "FLORIDAY_API_KEY"
)

check_op_version() {
    if ! command -v op &> /dev/null; then
        echo "Error: 1Password CLI (op) not found or not accessible" >&2
        exit 1
    fi

    version=$(op --version)
    if [[ ! $version == 2.30* ]]; then
        echo "Warning: This script was designed for op CLI version 2.30" >&2
    fi
}

load_credentials() {
    local vault="$1"
    if [ -z "$vault" ]; then
        echo "Error: Vault name is required" >&2
        echo "Usage: $0 load VAULT_NAME" >&2
        exit 1
    fi

    check_op_version

    # Get credentials from 1Password
    for var in "${VARIABLES[@]}"; do
        value=$(op item get "Floriday Staging" --vault "$vault" --field "$var" 2>/dev/null || {
            echo "Error: Could not fetch $var from 1Password" >&2
            exit 1
        })
        echo "export $var='$value'"
    done
}

unset_credentials() {
    for var in "${VARIABLES[@]}"; do
        echo "unset $var"
    done
}

case "$1" in
    "load")
        load_credentials "$2"
        ;;
    "unset")
        unset_credentials
        ;;
    *)
        echo "Usage: $0 COMMAND [ARGS]" >&2
        echo "" >&2
        echo "Commands:" >&2
        echo "  load VAULT_NAME    Load Floriday credentials from 1Password" >&2
        echo "  unset             Unset Floriday credentials" >&2
        exit 1
        ;;
esac
